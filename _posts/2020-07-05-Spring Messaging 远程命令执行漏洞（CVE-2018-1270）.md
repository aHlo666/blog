---
layout: post
title: Spring Messaging 远程命令执行漏洞
tags: Spring Messaging
categories: CVE-2018-1270
---

# Spring Messaging 远程命令执行漏洞（CVE-2018-1270）

## 漏洞描述

STOMP（Simple Text Orientated Messaging Protocol）全称为简单文本定向消息协议，它是一种在客户端与中转服务端（消息代理Broker）之间进行异步消息传输的简单通用协议，它定义了服务端与客户端之间的格式化文本传输方式。已经在被许多消息中间件与客户端工具所支持。

Spring框架中的 spring-messaging 模块提供了一种基于WebSocket的STOMP协议实现，STOMP消息代理在处理客户端消息时存在SpEL表达式注入漏洞，攻击者可以通过构造恶意的消息来实现远程代码执行。

spring messaging为spring框架提供消息支持，其上层协议是STOMP，底层通信基于SockJS，在spring messaging中，其允许客户端订阅消息，并使用selector过滤消息。selector用SpEL表达式编写，并使用StandardEvaluationContext解析，造成命令执行漏洞。

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。
环境启动后访问`http://your-ip:8080`可看到如下页面

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946231331205.jpg)

篡改前端app.js中Websocket connect函数中，插入恶意selector代码，

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946222178510.jpg)

PoC如下：

For Linux

`var header  = {"selector":"T(java.lang.Runtime).getRuntime().exec('string cmd')"};`

For Windows

`var header  = {"selector":"T(java.lang.Runtime).getRuntime().exec('calc.exe')"};`

修改代码后保存，然后点击Connect，然后随便输入内容点击send

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946192073467.jpg)

此处执行touch /tmp/success命令，然后进入docker容器查看，创建成功

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946192989628.jpg)

也可以执行命令反弹shell，java反弹shell需要编码

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946195158500.jpg)

攻击机开启监听，点击send后成功反弹shell

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946196236033.jpg)

使用[exploit](https://github.com/vulhub/vulhub/blob/master/spring/CVE-2018-1270/exploit.py)脚本，将Connect->Send的过程执行一遍来执行命令

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946210425331.jpg)

执行脚本

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946211972661.jpg)

进入容器查看创建成功

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946212380267.jpg)

也可以反弹shell，修改代码中的命令，需要编码

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946213530448.jpg)

攻击机开启监听，执行脚本，成功反弹shell

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Spring/CVE-2018-1270/15946214459771.jpg)

## 受影响版本

Spring Framework 5.0 to 5.0.4
Spring Framework 4.3 to 4.3.14
Spring Boot < 2.0.1 RELEASE

## 参考链接

https://kingx.me/spring-messaging-rce-cve-2018-1270.html

