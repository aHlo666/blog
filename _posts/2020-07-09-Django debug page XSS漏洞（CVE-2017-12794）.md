---
layout: post
title: Django debug page XSS漏洞
tags: Django
categories: CVE-2017-12794
---

# Django debug page XSS漏洞（CVE-2017-12794）

## 漏洞描述

Django 是一个开放源代码的 Web 应用框架，由 Python 写成。Django 采用了 MVT 的软件设计模式，即模型（Model），视图（View）和模板（Template）。

官方说明是500页面中出现的BUG，所以我们重点关注的就是django/views/debug.py。

Github上有Django的仓库，下载下来，用1.11.4和1.11.5进行比较：

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2017-12794/15946965058693.jpg)

该漏洞是Django的500页面出现的一个bug，Django为方便开发者进行SQL错误的调试，在出现数据库异常的时候，抛出错误语句并拼接进`The above exception ({{ frame.exc_cause }}) was the direct cause of the following exception`，输出到页面触发XSS。

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。

部署遇到的问题

首先Dockerfile中这个sh脚本地址打不开，

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2017-12794/15946944093346.jpg)

我换了一个<https://github.com/vishnubob/wait-for-it/blob/master/wait-for-it.sh>

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2017-12794/15946944430495.jpg)

然后部署完成之后web服务没起来，只起来一个数据库服务

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2017-12794/15946945727702.jpg)

然后手动启动后可以看到web服务监听的8000端口

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2017-12794/15946946418565.jpg)

访问`http://your-ip:8000`可以看到以下页面，然后可以使用/create_user/来创建用户

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2017-12794/15946947159466.jpg)

访问`http://127.0.0.1:8000/create_user/?username=%3Cscript%3Ealert(1)%3C/script%3E`创建一个用户

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2017-12794/15946948171646.jpg)

再次访问`http://your-ip:8000/create_user/?
username=<script>alert(1)</script>`，触发异常：

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2017-12794/15946950381958.jpg)

可见，Postgres抛出的异常为`duplicate key value violates unique constraint "xss_user_username_key"
DETAIL:  Key (username)=(<script>alert(1)</script>) already exists.`

这个异常被拼接进`The above exception ({{ frame.exc_cause }}) was the direct cause of the following exception`，最后触发XSS。

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2017-12794/15946958019625.jpg)

## 受影响版本

Django 1.10.x < 1.10.8
Django 1.11.x < 1.11.5